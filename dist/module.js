define(["lodash","app/core/table_model","app/plugins/sdk"],(function(t,e,r){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var a=e[n]={i:n,l:!1,exports:{}};return t[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)r.d(n,a,function(e){return t[e]}.bind(null,a));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/",r(r.s=7)}([function(e,r){e.exports=t},function(t,r){t.exports=e},function(t,e){t.exports=r},function(t,e,r){var n=r(4),a=r(5);"string"==typeof(a=a.__esModule?a.default:a)&&(a=[[t.i,a,""]]);var o={insert:"head",singleton:!1},i=(n(a,o),a.locals?a.locals:{});t.exports=i},function(t,e,r){"use strict";var n,a=function(){return void 0===n&&(n=Boolean(window&&document&&document.all&&!window.atob)),n},o=function(){var t={};return function(e){if(void 0===t[e]){var r=document.querySelector(e);if(window.HTMLIFrameElement&&r instanceof window.HTMLIFrameElement)try{r=r.contentDocument.head}catch(t){r=null}t[e]=r}return t[e]}}(),i=[];function s(t){for(var e=-1,r=0;r<i.length;r++)if(i[r].identifier===t){e=r;break}return e}function u(t,e){for(var r={},n=[],a=0;a<t.length;a++){var o=t[a],u=e.base?o[0]+e.base:o[0],c=r[u]||0,l="".concat(u," ").concat(c);r[u]=c+1;var f=s(l),h={css:o[1],media:o[2],sourceMap:o[3]};-1!==f?(i[f].references++,i[f].updater(h)):i.push({identifier:l,updater:v(h,e),references:1}),n.push(l)}return n}function c(t){var e=document.createElement("style"),n=t.attributes||{};if(void 0===n.nonce){var a=r.nc;a&&(n.nonce=a)}if(Object.keys(n).forEach((function(t){e.setAttribute(t,n[t])})),"function"==typeof t.insert)t.insert(e);else{var i=o(t.insert||"head");if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(e)}return e}var l,f=(l=[],function(t,e){return l[t]=e,l.filter(Boolean).join("\n")});function h(t,e,r,n){var a=r?"":n.media?"@media ".concat(n.media," {").concat(n.css,"}"):n.css;if(t.styleSheet)t.styleSheet.cssText=f(e,a);else{var o=document.createTextNode(a),i=t.childNodes;i[e]&&t.removeChild(i[e]),i.length?t.insertBefore(o,i[e]):t.appendChild(o)}}function d(t,e,r){var n=r.css,a=r.media,o=r.sourceMap;if(a?t.setAttribute("media",a):t.removeAttribute("media"),o&&btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),t.styleSheet)t.styleSheet.cssText=n;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(n))}}var p=null,m=0;function v(t,e){var r,n,a;if(e.singleton){var o=m++;r=p||(p=c(e)),n=h.bind(null,r,o,!1),a=h.bind(null,r,o,!0)}else r=c(e),n=d.bind(null,r,e),a=function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(r)};return n(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;n(t=e)}else a()}}t.exports=function(t,e){(e=e||{}).singleton||"boolean"==typeof e.singleton||(e.singleton=a());var r=u(t=t||[],e);return function(t){if(t=t||[],"[object Array]"===Object.prototype.toString.call(t)){for(var n=0;n<r.length;n++){var a=s(r[n]);i[a].references--}for(var o=u(t,e),c=0;c<r.length;c++){var l=s(r[c]);0===i[l].references&&(i[l].updater(),i.splice(l,1))}r=o}}}},function(t,e,r){(e=r(6)(!0)).push([t.i,".generic-datasource-query-row .query-keyword{width:75px}\n","",{version:3,sources:["query-editor.css"],names:[],mappings:"AAAA,6CAA6C,UAAU",file:"query-editor.css",sourcesContent:[".generic-datasource-query-row .query-keyword{width:75px}\n"]}]),t.exports=e},function(t,e,r){"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var r=function(t,e){var r=t[1]||"",n=t[3];if(!n)return r;if(e&&"function"==typeof btoa){var a=(i=n,s=btoa(unescape(encodeURIComponent(JSON.stringify(i)))),u="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),"/*# ".concat(u," */")),o=n.sources.map((function(t){return"/*# sourceURL=".concat(n.sourceRoot||"").concat(t," */")}));return[r].concat(o).concat([a]).join("\n")}var i,s,u;return[r].join("\n")}(e,t);return e[2]?"@media ".concat(e[2]," {").concat(r,"}"):r})).join("")},e.i=function(t,r,n){"string"==typeof t&&(t=[[null,t,""]]);var a={};if(n)for(var o=0;o<this.length;o++){var i=this[o][0];null!=i&&(a[i]=!0)}for(var s=0;s<t.length;s++){var u=[].concat(t[s]);n&&a[u[0]]||(r&&(u[2]?u[2]="".concat(r," and ").concat(u[2]):u[2]=r),e.push(u))}},e}},function(t,e,r){"use strict";r.r(e);var n=r(0),a=r.n(n),o=r(1),i=r.n(o);function s(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var u=function(){function t(e,r,n,a){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.q=r,this.backendSrv=n,this.templateSrv=a,this.url=e.url,this.withCredentials=e.withCredentials,this.basicAuth=e.basicAuth,this.name=e.name,this.id=e.id}var e,r,n;return e=t,(r=[{key:"testDatasource",value:function(){var t=this._requestOptions({url:this.url+"/r/v1/thruk?columns=rest_version",method:"GET"});return this.backendSrv.datasourceRequest(t).then((function(t){return 200===t.status&&t.data&&1===t.data.rest_version?{status:"success",message:"Data source is working",title:"Success"}:200===t.status&&t.data&&t.data.match(/login\.cgi/)?{status:"error",message:"Data source connected, but no valid data received. Verify authorization."}:{status:"error",message:t.status+" "+t.statusText}})).catch((function(t){return t.status&&t.status>=400?{status:"error",message:"Data source not connected: "+t.status+" "+t.statusText}:{status:"error",message:t.message}}))}},{key:"annotationQuery",value:function(t){var e=this._parseQuery(this._replaceVariables(t.annotation.query,t.range,t.scopedVars)),r=e.table.replace(/^\//,"");if("time"!=e.columns.split(/\s*,\s*/)[0])throw new Error("query syntax error, first column must be 'time' for annotations.");var n={columns:e.columns};n.q=e.where;var o=this._requestOptions({url:this.url+"/r/v1/"+r,method:"GET",params:n});return this.backendSrv.datasourceRequest(o).then((function(e){return a.a.map(e.data,(function(e,r){return{annotation:t.annotation,title:e.type,time:1e3*e.time,text:e.message.replace(/^\[\d+\]\s+/,"").replace(/^[^:]+:\s+/,""),tags:e.type}}))})).catch(this._handleQueryError.bind(this))}},{key:"metricFindQuery",value:function(t){var e=this._parseQuery(this._replaceVariables(t)),r=e.table+"?columns="+e.columns;r=r.replace(/^\//,""),e.where&&(r+="&q="+encodeURIComponent(e.where));var n=this._requestOptions({url:this.url+"/r/v1/"+r,method:"GET"});return this.backendSrv.datasourceRequest(n).then((function(t){return a.a.map(t.data,(function(t,e){return{text:Object.values(t).join(";"),value:Object.values(t).join(";")}}))})).catch(this._handleQueryError.bind(this))}},{key:"query",value:function(t){for(var e=this,r=0;r<t.targets.length;r++){var n=new i.a,o=t.targets[r],s=o.table,u=!1,c={};if(!s)return e.q.when([]);s=s.replace(/^\//,""),s=this._replaceVariables(s,t.range,t.scopedVars),o.columns||(o.columns=[]),"*"==o.columns[0]&&o.columns.shift();var l,f=!1;o.columns.length>0&&(o.columns.forEach((function(t){if(t.match(/^(.*)\(\)$/))return f=!0,!1})),c.columns=[],o.columns.forEach((function(t){var r=t.match(/^(.*)\(\)$/);r&&r[1]?l=r[1]:(l&&(t=l+"("+t+")",l=void 0),f||e._addColumn(n,t),c.columns.push(t))})),u=!0),o.condition&&(c.q=this._replaceVariables(o.condition,t.range,t.scopedVars)),o.limit&&(c.limit=o.limit);var h=e._requestOptions({url:e.url+"/r/v1/"+s,method:"GET",params:c});return e.backendSrv.datasourceRequest(h).then((function(r){return angular.isArray(r.data)||(r.data=[r.data]),u&&!f||!r.data[0]||Object.keys(r.data[0]).forEach((function(t){e._addColumn(n,t)})),a.a.map(r.data,(function(t,e){var r=[];n.columns.forEach((function(e){"time"==e.type?r.push(1e3*t[e.text]):r.push(t[e.text])})),n.rows.push(r)})),"timeseries"==o.type?e._fakeTimeseries(n,o,t,f):{data:[n]}})).catch(this._handleQueryError.bind(this))}}},{key:"_addColumn",value:function(t,e){e.match(/^(last_|next_|start_|end_|time)/)?t.addColumn({text:e,type:"time"}):t.addColumn({text:e})}},{key:"_requestOptions",value:function(t){return(t=t||{}).headers=t.headers||{},(this.basicAuth||this.withCredentials)&&(t.withCredentials=!0),this.basicAuth&&(t.headers.Authorization=this.basicAuth),t.headers["Content-Type"]="application/json",t}},{key:"_parseQuery",value:function(t){var e=t.match(/^\s*SELECT\s+([\w_,\ ]+)\s+FROM\s+([\w_\/]+)(|\s+WHERE\s+(.*))(|\s+LIMIT\s+(\d+))$/i);if(!e)throw new Error("query syntax error, expecting: SELECT <column>[,<columns>] FROM <rest url> [WHERE <filter conditions>] [LIMIT <limi>]");return{columns:e[1].replace(/\s+/g,""),table:e[2],where:e[4],limit:e[6]}}},{key:"_replaceVariables",value:function(t,e,r){if(t=this.templateSrv.replace(t,r,(function(t){return t&&angular.isArray(t)?"^("+t.join("|")+")$":t})),e&&(i=t.match(/(\w+)\s*=\s*\$time/))&&i[1]){var n=i[1],a="("+n+" > "+Math.floor(e.from.toDate().getTime()/1e3);a+=" AND "+n+" < "+Math.floor(e.to.toDate().getTime()/1e3),a+=")",t=t.replace(i[0],a)}for(var o=new RegExp(/([\w_]+)\s*(>=|=)\s*"\^\((.*?)\)\$"/),i=t.match(o);i;){var s=[];i[3].split("|").forEach((function(t){s.push(i[1]+" "+i[2]+' "'+t+'"')})),t=t.replace(i[0],"("+s.join(" OR ")+")"),i=t.match(o)}return t}},{key:"_handleQueryError",value:function(t){if(console.log(t),t.data&&t.data.code&&t.data.code>=400){var e="query error: "+t.data.message;throw t.data.description&&(e+=" - "+t.data.description),new Error(e)}if(t.status&&t.status>400)throw new Error("query error: "+t.status+" - "+t.statusText);throw new Error(t)}},{key:"_fakeTimeseries",value:function(t,e,r,n){var a={data:[]},o=r.range.from.unix(),i=r.range.to.unix(),s=Math.floor((i-o)/10);if(t.rows.length>1||n&&t.columnMap[":KEY"]){var u=0,c=0;return t.columns.forEach((function(t){if(":KEY"==t.text)return u=c,!1;c++})),t.rows.forEach((function(t){var e=[],r=t[u],n=t[1];if(t.length>2)throw new Error("timeseries from grouped stats queries with more than 2 columns are not supported.");for(var i=0;i<10;i++)e.push([n,1e3*(o+s*i)]);a.data.push({target:r,datapoints:e})})),a}return c=0,t.columns.forEach((function(e){for(var r=[],n=t.rows[0][c],i=0;i<10;i++)r.push([n,1e3*(o+s*i)]);a.data.push({target:e.text,datapoints:r}),c++})),a}}])&&s(e.prototype,r),n&&s(e,n),t}(),c=r(2);r(3);function l(t){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function f(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function h(t,e){return(h=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function d(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=m(t);if(e){var a=m(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return p(this,r)}}function p(t,e){return!e||"object"!==l(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function m(t){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var v=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&h(t,e)}(o,t);var e,r,n,a=d(o);function o(t,e,r){var n;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,o),(n=a.call(this,t,e)).scope=t,n.uiSegmentSrv=r,n.target.table=n.target.table||"/",n.target.columns=n.target.columns||["*"],n.target.condition=n.target.condition||"",n.target.type=n.target.type||"table",n.setColSegments(),n}return e=o,(r=[{key:"getTypes",value:function(){var t=[this.uiSegmentSrv.newSegment({text:"table",value:"table"}),this.uiSegmentSrv.newSegment({text:"timeseries",value:"timeseries"})];return this.datasource.q.when(t)}},{key:"getTables",value:function(){var t=this.datasource._requestOptions({url:this.datasource.url+"/r/v1/index?columns=url&protocol=get",method:"GET",headers:{"Content-Type":"application/json"}});return this.datasource.backendSrv.datasourceRequest(t).then((function(t){return _.map(t.data,(function(t,e){return{text:t.url,value:t.url}}))})).then(this.uiSegmentSrv.transformToSegments(!1)).catch(this.datasource._handleQueryError.bind(this))}},{key:"getColumns",value:function(){var t=this,e=this.datasource._requestOptions({url:this.datasource.url+"/r/v1/"+this.target.table+"?limit=1",method:"GET",headers:{"Content-Type":"application/json"}});return this.datasource.backendSrv.datasourceRequest(e).then((function(e){var r=[t.uiSegmentSrv.newOperator("-- remove --"),t.uiSegmentSrv.newOperator("avg()"),t.uiSegmentSrv.newOperator("min()"),t.uiSegmentSrv.newOperator("max()"),t.uiSegmentSrv.newOperator("sum()"),t.uiSegmentSrv.newOperator("count()")];return e.data[0]&&Object.keys(e.data[0]).forEach((function(e){r.push(t.uiSegmentSrv.newSegment({text:e,value:e}))})),r})).catch(this.datasource._handleQueryError.bind(this))}},{key:"tagSegmentUpdated",value:function(t,e){this.target.columns[e]=t.value,"-- remove --"==t.value&&this.target.columns.splice(e,1),this.setColSegments(),this.onChangeInternal()}},{key:"setColSegments",value:function(){var t=this;this.colSegments=[],angular.isArray(this.target.columns)||(this.target.columns?this.target.columns=this.target.columns.split("s*,s*"):this.target.columns=["*"]),this.target.columns.forEach((function(e){t.colSegments.push(t.uiSegmentSrv.newSegment({value:e}))})),0==this.colSegments.length?this.colSegments.push(this.uiSegmentSrv.newSegment({value:"*"})):this.colSegments[this.colSegments.length-1].text&&this.colSegments[this.colSegments.length-1].text.match(/\(\)$/)&&this.colSegments.push(this.uiSegmentSrv.newSegment({value:" "})),this.colSegments.push(this.uiSegmentSrv.newPlusButton())}},{key:"onChangeInternal",value:function(){this.panelCtrl.refresh()}},{key:"getCollapsedText",value:function(){var t="SELECT "+this.target.columns.join(",")+" FROM "+this.target.table;return this.target.condition&&(t+=" WHERE "+this.target.condition),this.target.limit&&(t+=" LIMIT "+this.target.limit),t}}])&&f(e.prototype,r),n&&f(e,n),o}(c.QueryCtrl);function g(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}v.templateUrl="partials/query.editor.html",r.d(e,"ConfigCtrl",(function(){return y})),r.d(e,"QueryOptionsCtrl",(function(){return b})),r.d(e,"AnnotationsQueryCtrl",(function(){return S})),r.d(e,"Datasource",(function(){return u})),r.d(e,"QueryCtrl",(function(){return v}));var y=function t(){g(this,t)};y.templateUrl="partials/config.html";var b=function t(){g(this,t)};b.templateUrl="partials/query.options.html";var S=function t(){g(this,t)};S.templateUrl="partials/annotations.editor.html"}])}));
//# sourceMappingURL=module.js.map